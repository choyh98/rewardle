# 🐛 긴급 버그 수정 (2026-01-22 오후)

## 수정된 문제들

### 1. ✅ 포인트 계산 오류 수정
**문제:** 총 포인트가 실제보다 적게 표시됨 (34P → 22P)
**원인:** `addPoints` 함수에서 이전 state 값을 참조하는 문제
**해결:** 최신 포인트 값을 사용하도록 수정

```typescript
// 이전
localStorage.setItem('rewardle_points', (points + amount).toString());

// 수정
const newPoints = points + amount;
localStorage.setItem('rewardle_points', newPoints.toString());
```

### 2. ✅ 일일 출석 체크 중복 기록 방지
**문제:** 같은 날짜에 출석 체크가 2번 기록됨
**원인:** Supabase 중복 체크 없이 삽입
**해결:** 출석 기록 전 같은 날짜 기록이 있는지 확인

```typescript
// 중복 체크 후 삽입
const { data: existingRecord } = await supabase
    .from('attendance')
    .select('id')
    .eq('user_id', userId)
    .eq('check_date', todayISO)
    .maybeSingle();

if (!existingRecord) {
    await supabase.from('attendance').insert({...});
}
```

### 3. ✅ 사과 게임 드래그 시 스크롤 문제 수정
**문제:** 사과를 드래그할 때 화면이 스크롤되어 드래그가 안됨
**원인:** 터치 이벤트가 스크롤 이벤트로 전파됨
**해결:** `touch-none` CSS 클래스 추가

```tsx
<div className="... touch-none" ...>
```

### 4. ✅ 게임 완료 후 추가 미션 팝업 표시 문제 수정 ⭐ 중요!
**문제:** 마지막 게임(10번째) 완료 시 추가 미션 팝업이 안 뜨고 "게임 횟수 모두 사용" 알림만 뜸
**원인:** 게임 시작 시점에 횟수를 차감해서 `canPlayGame()`이 `false`가 되어버림
**해결:** 게임 **완료 시점**에 횟수 차감하도록 변경 + 페이지 이탈 시에도 차감 처리

```typescript
// 게임 완료 시점에 횟수 차감
const handleComplete = (earnedPoints: number) => {
    recordGameCompletion(gameTypeKey, brand.id);
    setGameCompleted(true);
    // ... 포인트 지급
};

// 페이지 이탈 시에도 차감 (뒤로가기 등)
useEffect(() => {
    return () => {
        if (!gameCompleted) {
            recordGameCompletion(gameTypeKey, brand.id);
        }
    };
}, [gameCompleted]);
```

---

## 변경된 파일

1. `src/context/PointsContext.tsx` - 포인트 계산 로직 수정
2. `src/pages/AttendancePage.tsx` - 출석 중복 방지
3. `src/components/games/AppleGame.tsx` - 드래그 스크롤 문제 해결
4. `src/pages/GamePage.tsx` - ⭐ 게임 횟수 차감 시점 변경 (완료 시점으로)

---

## 테스트 필요 사항

- [ ] 포인트 적립 후 정확한 총 포인트 표시 확인
- [ ] 출석 체크 중복 기록 없는지 확인 (Supabase attendance 테이블)
- [ ] 사과 게임에서 드래그 정상 작동 확인
- [ ] ⭐ **중요!** 게임 9회 완료 후 10번째 게임 완료 시 추가 미션 팝업 정상 표시 확인
- [ ] 게임 도중 뒤로가기 해도 횟수 차감 확인

---

**수정 완료 시간:** 2026-01-22 11:50

