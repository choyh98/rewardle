# π”’ λ¦¬μ›λ“¤ λ³΄μ• κ°•ν™” κ°€μ΄λ“

## κ°μ”
μ΄ λ¬Έμ„λ” λ¦¬μ›λ“¤ μ‹μ¤ν…μ μ–΄λ·°μ§• λ°©μ§€ λ° λ³΄μ• κ°•ν™” μ΅°μΉλ¥Ό μ„¤λ…ν•©λ‹λ‹¤.

---

## π¨ λ°κ²¬λ μ·¨μ•½μ 

### 1. μΉλ…μ μΈ λ³΄μ• μ·¨μ•½μ 
κΈ°μ΅΄ μ‹μ¤ν…μ—μ„λ” ν΄λΌμ΄μ–ΈνΈ(ν”„λ΅ νΈμ—”λ“)κ°€ λ°μ΄ν„°λ² μ΄μ¤λ¥Ό **μ§μ ‘ μμ •**ν•  μ μμ—μµλ‹λ‹¤.

**λ¬Έμ μ :**
```javascript
// λΈλΌμ°μ € μ½μ†”μ—μ„ λ„κµ¬λ‚ μ‹¤ν–‰ κ°€λ¥ν–λ μ½”λ“
await supabase.from('user_points').update({ points: 999999 }).eq('user_id', 'my_id');
// β†’ μ¦‰μ‹ 100λ§ ν¬μΈνΈ νλ“! π±
```

### 2. κΈ°νƒ€ μ·¨μ•½μ 
- β κ²μ„ μ‹κ°„ κ²€μ¦ μ—†μ (1μ΄ λ§μ— ν΄λ¦¬μ–΄ κ°€λ¥)
- β μΌμΌ ν•λ„ μ ν• μ—†μ (λ¬΄μ ν• ν¬μΈνΈ νλ“)
- β μ¤‘λ³µ μ¶μ„ μ²΄ν¬ λ°©μ§€ λ―Έν΅
- β λΉ„μ •μƒμ μΈ ν¬μΈνΈ μ”μ²­ μ°¨λ‹¨ μ—†μ

---

## β… μ μ©λ λ³΄μ• μ΅°μΉ

### 1. RLS(Row Level Security) μ •μ±… κ°•ν™”
**λ³€κ²½ μ „:**
```sql
-- μ‚¬μ©μκ°€ μ§μ ‘ μμ • κ°€λ¥ (μ·¨μ•½!)
CREATE POLICY "Users can update own points"
    ON user_points FOR UPDATE
    USING (auth.uid()::text = user_id);
```

**λ³€κ²½ ν›„:**
```sql
-- μ§μ ‘ μμ • λ¶κ°€! μ¤μ§ SELECTλ§ ν—μ©
DROP POLICY "Users can update own points" ON user_points;
-- β†’ μ΄μ  μ΅°νλ§ κ°€λ¥, μμ •μ€ RPC ν•¨μλ¥Ό ν†µν•΄μ„λ§!
```

### 2. λ³΄μ• RPC ν•¨μ κµ¬ν„

#### 2-1. ν¬μΈνΈ μ λ¦½ ν•¨μ
```sql
CREATE FUNCTION secure_add_points(
    p_user_id TEXT,
    p_amount INTEGER,
    p_reason TEXT
)
```

**λ³΄μ• κ²€μ¦ ν•­λ©:**
- β… μΌμΌ μµλ€ ν¬μΈνΈ ν•λ„: 100P
- β… ν¬μΈνΈ λ²”μ„ κ²€μ¦: 0 < amount β‰¤ 100
- β… λΉ„μ •μƒμ μΈ μ”μ²­ μ°¨λ‹¨

#### 2-2. κ²μ„ μ„Έμ… ν•¨μ
```sql
-- κ²μ„ μ‹μ‘
CREATE FUNCTION start_game_session(...)
-- κ²μ„ μ™„λ£ (μ‹κ°„ κ²€μ¦ ν¬ν•¨)
CREATE FUNCTION complete_game_session(...)
```

**λ³΄μ• κ²€μ¦ ν•­λ©:**
- β… μΌμΌ κ²μ„ νμ μ ν•: 10ν
- β… μµμ† κ²μ„ μ‹κ°„: 10μ΄ (λ„λ¬΄ λΉ λ¥Έ ν΄λ¦¬μ–΄ μ°¨λ‹¨)
- β… μµλ€ κ²μ„ μ‹κ°„: 5λ¶„ (νƒ€μ„μ•„μ›ƒ)
- β… μ¤‘λ³µ μ™„λ£ λ°©μ§€

#### 2-3. μ¶μ„ μ²΄ν¬ ν•¨μ
```sql
CREATE FUNCTION secure_check_attendance(...)
```

**λ³΄μ• κ²€μ¦ ν•­λ©:**
- β… ν•λ£¨ 1ν μ¶μ„λ§ ν—μ©
- β… μ—°μ† μ¶μ„ μλ™ κ³„μ‚°
- β… μ¤‘λ³µ μ¶μ„ μ°¨λ‹¨

#### 2-4. λ―Έμ… μ™„λ£ ν•¨μ
```sql
CREATE FUNCTION complete_mission(...)
```

**λ³΄μ• κ²€μ¦ ν•­λ©:**
- β… μΌμΌ λ―Έμ… νμ μ ν•: 10ν
- β… λ―Έμ… νƒ€μ… κ²€μ¦

### 3. ν”„λ΅ νΈμ—”λ“ μ½”λ“ λ³€κ²½

**λ³€κ²½ μ „ (μ·¨μ•½):**
```typescript
// μ§μ ‘ ν…μ΄λΈ” μμ •
await supabase.from('user_points').update({ points: newPoints });
```

**λ³€κ²½ ν›„ (λ³΄μ•):**
```typescript
// RPC ν•¨μ νΈμ¶ (μ„λ²„ μΈ΅ κ²€μ¦ ν†µκ³Ό ν•„μ”)
const { data } = await supabase.rpc('secure_add_points', {
    p_user_id: userId,
    p_amount: points,
    p_reason: reason
});
```

---

## π“‹ μ„¤μΉ λ° λ°°ν¬ κ°€μ΄λ“

### 1λ‹¨κ³„: Supabase λ°μ΄ν„°λ² μ΄μ¤ μ—…λ°μ΄νΈ

1. Supabase Dashboard μ ‘μ†
2. SQL Editor μ—΄κΈ°
3. `supabase_secure_functions.sql` νμΌ λ‚΄μ© λ³µμ‚¬ & λ¶™μ—¬λ„£κΈ°
4. **Run** λ²„νΌ ν΄λ¦­
5. μ„±κ³µ λ©”μ‹μ§€ ν™•μΈ

### 2λ‹¨κ³„: ν”„λ΅ νΈμ—”λ“ μ½”λ“ λ°°ν¬

λ³€κ²½λ νμΌλ“¤:
- β… `src/services/pointService.ts` (RPC ν•¨μ νΈμ¶)
- β… `src/services/gameService.ts` (κ²μ„ μ„Έμ… κ΄€λ¦¬)
- β… `src/services/attendanceService.ts` (μ¶μ„ RPC)
- β… `src/services/missionService.ts` (μƒλ΅ μ¶”κ°€)
- β… `src/lib/services.ts` (export μ¶”κ°€)

```bash
# Git μ»¤λ°‹ & ν‘Έμ‹
git add .
git commit -m "λ³΄μ• κ°•ν™”: RPC ν•¨μ μ μ©, μ–΄λ·°μ§• λ°©μ§€"
git push origin main
```

### 3λ‹¨κ³„: ν…μ¤νΈ

#### κΈ°λ¥ ν…μ¤νΈ
- [ ] κ²μ„ ν”λ μ΄ μ •μƒ μ‘λ™
- [ ] ν¬μΈνΈ μ λ¦½ μ •μƒ μ‘λ™
- [ ] μ¶μ„ μ²΄ν¬ μ •μƒ μ‘λ™
- [ ] λ―Έμ… μ™„λ£ μ •μƒ μ‘λ™

#### λ³΄μ• ν…μ¤νΈ
λΈλΌμ°μ € μ½μ†”μ—μ„ λ‹¤μ λ…λ Ήμ–΄λ¥Ό μ‹λ„ν–μ„ λ• **μ‹¤ν¨**ν•΄μ•Ό ν•©λ‹λ‹¤:

```javascript
// β μ΄μ  μ‘λ™ν•μ§€ μ•μ•„μ•Ό ν•¨
await supabase.from('user_points').update({ points: 999999 });
// β†’ Error: permission denied
```

---

## π›΅οΈ λ³΄μ• μμ¤€ λΉ„κµ

### λ³€κ²½ μ „
| κ³µκ²© μ ν• | μ·¨μ•½μ„± | μ„ν—λ„ |
|---------|-------|-------|
| μ½μ†” μ΅°μ‘ | β οΈ κ°€λ¥ | π”΄ λ†’μ |
| μ†λ„ ν•µ | β οΈ κ°€λ¥ | π”΄ λ†’μ |
| λ¬΄ν• ν¬μΈνΈ | β οΈ κ°€λ¥ | π”΄ λ†’μ |
| μ¤‘λ³µ μ¶μ„ | β οΈ κ°€λ¥ | π΅ μ¤‘κ°„ |

### λ³€κ²½ ν›„
| κ³µκ²© μ ν• | μ·¨μ•½μ„± | μ„ν—λ„ |
|---------|-------|-------|
| μ½μ†” μ΅°μ‘ | β… μ°¨λ‹¨ | πΆ λ‚®μ |
| μ†λ„ ν•µ | β… μ°¨λ‹¨ | πΆ λ‚®μ |
| λ¬΄ν• ν¬μΈνΈ | β… μ°¨λ‹¨ | πΆ λ‚®μ |
| μ¤‘λ³µ μ¶μ„ | β… μ°¨λ‹¨ | πΆ λ‚®μ |

---

## π“ μΌμΌ ν•λ„ μ„¤μ •

| ν•­λ© | ν•λ„ | λ©μ  |
|-----|------|------|
| μµλ€ ν¬μΈνΈ | 100P/μΌ | μ–΄λ·°μ§• λ°©μ§€ |
| κ²μ„ νμ | 10ν/μΌ | κ³Όλ„ν• ν”λ μ΄ μ ν• |
| λ―Έμ… νμ | 10ν/μΌ | λ―Έμ… λ‚¨μ© λ°©μ§€ |
| μµμ† κ²μ„ μ‹κ°„ | 10μ΄ | μ†λ„ ν•µ μ°¨λ‹¨ |
| μµλ€ κ²μ„ μ‹κ°„ | 5λ¶„ | νƒ€μ„μ•„μ›ƒ |

---

## π”§ μ»¤μ¤ν„°λ§μ΄μ§•

ν•λ„λ¥Ό λ³€κ²½ν•λ ¤λ©΄ `supabase_secure_functions.sql` νμΌμ—μ„ λ‹¤μ κ°’μ„ μμ •ν•μ„Έμ”:

```sql
-- μΌμΌ μµλ€ ν¬μΈνΈ
v_max_daily_points INTEGER := 100;

-- μΌμΌ κ²μ„ νμ
v_max_daily_plays INTEGER := 10;

-- μΌμΌ λ―Έμ… νμ
v_max_daily_missions INTEGER := 10;

-- μµμ†/μµλ€ κ²μ„ μ‹κ°„
v_min_time INTEGER := 10;  -- 10μ΄
v_max_time INTEGER := 300; -- 5λ¶„
```

---

## β οΈ μ£Όμμ‚¬ν•­

1. **κΈ°μ΅΄ μ‚¬μ©μ μν–¥ μ—†μ**
   - μ΅°ν κ¶ν•μ€ κ·Έλ€λ΅ μ μ§€λ©λ‹λ‹¤.
   - ν¬μΈνΈλ” RPC ν•¨μλ¥Ό ν†µν•΄ μ •μƒμ μΌλ΅ μ λ¦½λ©λ‹λ‹¤.

2. **κ²μ¤νΈ μ‚¬μ©μ μ§€μ›**
   - `user_id LIKE 'guest_%'` ν¨ν„΄μ€ κ³„μ† μ‘λ™ν•©λ‹λ‹¤.

3. **λ κ±°μ‹ ν•¨μ ν•μ„ νΈν™μ„±**
   - κΈ°μ΅΄ `recordGameCompletion`, `recordAttendance` ν•¨μλ” λ‚΄λ¶€μ μΌλ΅ RPCλ¥Ό νΈμ¶ν•©λ‹λ‹¤.
   - μ μ§„μ  λ§μ΄κ·Έλ μ΄μ… κ°€λ¥.

4. **μ—λ¬ ν•Έλ“¤λ§**
   - RPC ν•¨μκ°€ μ‹¤ν¨ν•λ©΄ λ…ν™•ν• μ—λ¬ λ©”μ‹μ§€λ¥Ό λ°ν™ν•©λ‹λ‹¤.
   - ν”„λ΅ νΈμ—”λ“μ—μ„ μ μ ν μ²λ¦¬ν•μ„Έμ”.

---

## π― κ²°κ³Ό

### Before (μ·¨μ•½)
```
μ‚¬μ©μ β†’ Supabase μ§μ ‘ μμ • β†’ ν¬μΈνΈ λ³€κ²½ β… (λ„λ¬΄ μ‰¬μ›€!)
```

### After (λ³΄μ•)
```
μ‚¬μ©μ β†’ RPC ν•¨μ νΈμ¶ β†’ μ„λ²„ μΈ΅ κ²€μ¦ β†’ ν†µκ³Ό μ‹μ—λ§ ν¬μΈνΈ λ³€κ²½ β…
                     β†“
                  κ²€μ¦ μ‹¤ν¨ μ‹ μ°¨λ‹¨ β
```

---

## π“ λ¬Έμ

λ³΄μ• κ΄€λ ¨ λ¬Έμ λ‚ μ¶”κ°€ μ΅°μΉκ°€ ν•„μ”ν•λ©΄ κ°λ°ν€μ— λ¬Έμν•μ„Έμ”.

**μ΄μ  λ¦¬μ›λ“¤μ€ μ•μ „ν•©λ‹λ‹¤! π”’β¨**
